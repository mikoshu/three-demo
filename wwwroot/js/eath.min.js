var GLOBE_RADIUS=600,global=function(){function e(){s=document.getElementById("container"),o=new THREE.Scene,h=new THREE.PerspectiveCamera(60,x/(T+u),1,3500),h.position.z=2080,o.add(h),l=new THREE.WebGLRenderer({antialias:!0,alpha:!0}),l.setClearColor(16777215,0),l.setPixelRatio(window.devicePixelRatio),l.setSize(x,T+u),s.appendChild(l.domElement),r=new THREE.OrbitControls(h,l.domElement);var e,a,n=new Date,E=n.getHours();8>=E||E>=18?(e="http://img5.91huo.cn/101/www/2017/v1/img/1703/3.jpg",a=10398207):(e="http://img5.91huo.cn/101/www/2017/v1/img/1703/5.jpg",a=16777118);var p=new THREE.AmbientLight(12237562,1);o.add(p);var w=new THREE.PointLight(16777215,.4);w.position.set(-500,1800,200),h.add(w);var g=new THREE.PointLight(a,.5);g.position.set(500,2e3,200),h.add(g),c=new THREE.Group,o.add(c);var R=new THREE.TextureLoader;R.load(e,function(e){e.minFilter=THREE.LinearFilter;var t=new THREE.SphereGeometry(598,50,50),i=new THREE.MeshPhongMaterial({map:e,overdraw:1});d=new THREE.Mesh(t,i),d.castShadow=!0,c.add(d)}),c.rotation.y=Math.PI/1.5,$(".home-item").each(function(){var e=new HomeItem(this,!0);m.push(e)});for(var v=0,H=m.length;H>v;v++)c.add(m[v].normalObj),o.add(m[v].line);t("all"),window.addEventListener("resize",i,!1)}function t(e,t){_isActive=!0,_filterId=e;for(var i=0,a=m.length;a>i;i++)("all"==_filterId||_filterId==m[i].data.category)&&m[i].show(.1,(t?0:p?1:1.4)+.3*Math.random())}function i(){var e=$(".earth").width(),t=$(".earth").height();h.aspect=e/(t+u),h.updateProjectionMatrix(),l.setSize(e,t+u)}function a(){E=requestAnimationFrame(a),r.update(),n()}function n(){var e,t,i,a,n,s,r=(new THREE.Vector3).setFromMatrixPosition(h.matrixWorld),d=h.position.clone().sub(c.position).normalize(),E=.1*w,u=.1*g;w-=E,g-=u,h.lookAt(o.position),c.rotation.y+=.005,l.render(o,h),l.clearTarget(null,!1,!0);for(var x=0,T=m.length;T>x;x++){e=m[x];var n=e.visibleValue,p=e.data.ispic;t=e.normalObj,i=(new THREE.Matrix3).getNormalMatrix(t.matrixWorld),a=new THREE.Vector3(0,0,1).applyMatrix3(i).normalize(),e.line.position.setFromMatrixPosition(t.matrixWorld),e.line.lookAt(h.position);var R=a.dot(d),v=R>0&&n>0;if(s=1==p?e.text:2==p?e.dot:e.plane,v){e.line.traverse(function(){}),e.line.scale.x=e.line.scale.y=e.line.scale.z=n,e.distance=r.distanceTo((new THREE.Vector3).setFromMatrixPosition(s.matrixWorld))}else e.distance=99999;e.line.visible=v}}var s,r,h,o,l,c,d,E,u=935,x=$(".earth").width(),T=$(".earth").height(),p=!1,m=[],w=10,g=10;return indexF.homeItem("#container","all",!1),e(),a(),global},HomeItem=function(){function e(e,t){var i=this;this.isShitty=t,this.target=$(e),this.data=this.target.data(),this.url=this.target.attr("href"),this.isPic=this.data.ispic,this.color=this.data.color,this.normalObj=new THREE.Object3D;var a=new THREE.Quaternion;a.setFromAxisAngle(new THREE.Vector3(1,0,0).normalize(),-this.data.lat/180*p),this.normalObj.quaternion.multiplyQuaternions(a,this.normalObj.quaternion),a=new THREE.Quaternion,a.setFromAxisAngle(new THREE.Vector3(0,1,0).normalize(),(90+this.data.lng)/180*p),this.normalObj.quaternion.multiplyQuaternions(a,this.normalObj.quaternion),this.normalObj.translateZ(GLOBE_RADIUS),1==this.isPic?(this._buildAddressLine(),this._buildAddressText(),this._buildAddressDot()):2==this.isPic?(this._buildRed(),this._buildRedDot()):(this._buildLine(),this._buildPlane()),this.visibleValue=0,this.hoverValue=0,this._boundUpdate=function(){i._update()}}function t(){this.lineMaterial=new THREE.MeshBasicMaterial({color:this.color,transparent:!0});var e=new THREE.CircleGeometry(1,0,0,Math.PI/6);this.line=new THREE.Mesh(e,this.lineMaterial);var t=this.planeCanvas=document.createElement("canvas");t.width=t.height=0,this.planeCtx=t.getContext("2d"),this.lineMaterial=new THREE.MeshBasicMaterial({color:this.color,transparent:!0});var e=new THREE.CircleGeometry(5,12,0,2*Math.PI);this.dot=new THREE.Mesh(e,this.lineMaterial),this.dot.homeItem=this,this.dot.position.y=2,this.line.add(this.dot);var i=new THREE.MeshBasicMaterial({color:16777215,transparent:!0}),a=new THREE.CircleGeometry(3,20,0,2*Math.PI),n=new THREE.Mesh(a,i);n.position.y=2,n.position.z=1,this.line.add(n)}function i(){var e=document.createElement("canvas");e.width=256,e.height=56;for(var t=e.getContext("2d"),i=this.target.find(".home-item-name").text(),a=i.split(" "),n=[],s="",r=128,h=24,o=0;o<a.length;o++){var l=s+a[o]+" ",c=t.measureText(l).width;c>256&&o>0?(n.push(s),s=a[o]+" ",h+=24):s=l}n.push(s),e.height=24*n.length+8,t.fillStyle=this.color,t.font="22px microsoft yahei",t.textAlign="center";for(var o=0,d=n.length;d>o;o++)t.fillText(n[o],r,24*(o+1));var E=new THREE.PlaneGeometry(256,e.height,32,32);this.textTexture=new THREE.Texture(e),this.textTexture.magFilter=THREE.NearestFilter,this.textTexture.minFilter=THREE.NearestFilter,this.textTexture.generateMipmaps=!1,this.textMaterial=new THREE.MeshBasicMaterial({map:this.textTexture,transparent:!0}),this.text=new THREE.Mesh(E,this.textMaterial),this.text.position.y=this.textY=5+.6*e.height,this.text.position.z=50,this.text.scale.x=this.text.scale.y=.5,this.text.homeItem=this,this.textTexture.needsUpdate=!0,this.line.add(this.text)}function a(){this.lineMaterial=new THREE.MeshBasicMaterial({color:this.color,transparent:!0});var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(-3,8,0),new THREE.Vector3(3,8,0),new THREE.Vector3(-0,0,0),new THREE.Vector3(0,0,0)),e.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3)),e.computeBoundingSphere(),this.line=new THREE.Mesh(e,this.lineMaterial),this.isShitty||(this.cloneLine=new THREE.Mesh(e,this.lineMaterial))}function n(){this.lineMaterial=new THREE.MeshBasicMaterial({color:this.color,transparent:!0});var e=new THREE.Geometry;e.vertices.push(new THREE.Vector3(-.5,100,0),new THREE.Vector3(.5,100,0),new THREE.Vector3(-.5,10,0),new THREE.Vector3(.5,10,0)),e.faces.push(new THREE.Face3(0,2,1),new THREE.Face3(1,2,3)),e.computeBoundingSphere(),this.line=new THREE.Mesh(e,this.lineMaterial)}function s(){this.lineMaterial=new THREE.MeshBasicMaterial({color:this.color});var e=new THREE.SphereGeometry(5,20,20),t=new THREE.Mesh(e,this.lineMaterial);t.position.y=10,this.line.add(t)}function r(){var e=this,t=this.planeCanvas=document.createElement("canvas");t.width=t.height=82,this.planeCtx=t.getContext("2d");var i=new THREE.PlaneGeometry(80,80),a=this.planeImg=new Image;a.crossOrigin="anonymous",this.planeTexture=new THREE.Texture(t),this.planeTexture.minFilter=THREE.LinearFilter,this.planeMaterial=new THREE.MeshBasicMaterial({map:this.planeTexture,transparent:!0,depthWrite:!1}),this.plane=new THREE.Mesh(i,this.planeMaterial),this.plane.position.y=26,this.plane.position.z=1,this.plane.scale.x=this.plane.scale.y=.5,this.plane.homeItem=this,this.plane.interactive=this,this.line.add(this.plane),a.src="http://img4.91huo.cn/101/www/2017/v1/img/"+this.data.directoryimage+this.data.image,a.onload=function(){e._onPlaneImgLoaded(a)}}function h(){var e=document.createElement("canvas");e.width=256,e.height=56;for(var t=e.getContext("2d"),i=this.target.find(".home-item-name").text(),a=i.split(" "),n=[],s="",r=128,h=24,o=0;o<a.length;o++){var l=s+a[o]+" ",c=t.measureText(l).width;c>256&&o>0?(n.push(s),s=a[o]+" ",h+=24):s=l}n.push(s),e.height=24*n.length+8,t.fillStyle=this.color,t.font="28px Microsoft YaHei",t.textAlign="center";for(var o=0,d=n.length;d>o;o++)t.fillText(n[o],r,24*(o+1));var E=new THREE.PlaneGeometry(256,e.height,32,32);this.textTexture=new THREE.Texture(e),this.textTexture.magFilter=THREE.NearestFilter,this.textTexture.minFilter=THREE.NearestFilter,this.textTexture.generateMipmaps=!1,this.textMaterial=new THREE.MeshBasicMaterial({map:this.textTexture,transparent:!0}),this.text=new THREE.Mesh(E,this.textMaterial),this.text.position.y=this.textY=70+.6*e.height+30,this.text.scale.x=this.text.scale.y=.5,this.text.homeItem=this,this.textTexture.needsUpdate=!0,this.line.add(this.text)}function o(){var e=document.createElement("canvas");e.width=256,e.height=56;for(var t=e.getContext("2d"),i=this.target.find(".home-item-name").text(),a=i.split(" "),n=[],s="",r=128,h=24,o=0;o<a.length;o++){var l=s+a[o]+" ",c=t.measureText(l).width;c>256&&o>0?(n.push(s),s=a[o]+" ",h+=24):s=l}n.push(s),e.height=24*n.length+8,t.fillStyle="#fff",t.font="22px questrialregular",t.textAlign="center";for(var o=0,d=n.length;d>o;o++)t.fillText(n[o],r,24*(o+1)),this.isShitty&&(t.fillText(n[o],r+.75,24*(o+1)),t.fillText(n[o],r-.75,24*(o+1)));var E=new THREE.PlaneGeometry(256,e.height);this.textTexture=new THREE.Texture(e),this.textMaterial=new THREE.MeshBasicMaterial({map:this.textTexture,transparent:!0}),this.text=new THREE.Mesh(E,this.textMaterial),this.text.position.y=this.textY=100+.6*e.height+30,this.text.scale.x=this.text.scale.y=.1,this.text.homeItem=this,this.textTexture.needsUpdate=!0,this.line.add(this.text),this.isShitty||(this.cloneText=new THREE.Mesh(E,this.textMaterial),this.cloneText.position.y=this.textY,this.cloneText.scale.x=this.cloneText.scale.y=.5,this.cloneLine.add(this.cloneText))}function l(){var e=this.planeCtx,t=this.hoverValue;if(e.clearRect(0,0,80,80),this.planeImg.width){var i=1+.1*t;e.save(),e.beginPath(),e.arc(40,40,38,0,2*p),e.clip(),e.save(),e.drawImage(this.planeImg,0,0),e.translate(41,40),e.scale(i,i),e.translate(-40,-40),e.restore()}e.beginPath(),e.arc(40,40,38,0,2*p),e.strokeStyle=this.color,e.lineWidth=6,e.stroke(),e.closePath(),this.planeTexture.needsUpdate=!0}function c(){this._updatePlaneTexture()}function d(e,t){TweenLite.killTweensOf(this),TweenLite.to(this,e||0,{visibleValue:1,delay:t||0,ease:"easeOutBack"})}function E(e,t){TweenLite.killTweensOf(this),TweenLite.to(this,e||0,{visibleValue:0,delay:t||0,ease:"easeInBack"})}function u(){this._updatePlaneTexture(),this.text.position.y=this.textY+7*this.hoverValue,this.isNew&&(this.newIcon.scale.x=this.newIcon.scale.y=.3+.1*this.hoverValue,this.newIcon.rotation.z=-.1*this.hoverValue),this.isShitty||(this.cloneText.position.y=this.textY+7*this.hoverValue,this.isNew&&(this.cloneNewIcon.scale.x=this.cloneNewIcon.scale.y=.3+.1*this.hoverValue,this.cloneNewIcon.rotation.z=-.1*this.hoverValue))}function x(){this.isShitty||TweenLite.to(this,.3,{hoverValue:1,ease:"easeInOutSine",onUpdate:this._boundUpdate})}function T(){this.isShitty||TweenLite.to(this,.3,{hoverValue:0,ease:"easeInOutSine",onUpdate:this._boundUpdate})}var p=Math.PI,m=document.createElement("canvas").getContext("2d");m.globalCompositeOperation="screen";var w=("screen"==m.globalCompositeOperation,e.prototype);return w.show=d,w.hide=E,w._onPlaneImgLoaded=c,w._buildLine=a,w._buildRed=t,w._buildAddressLine=n,w._buildPlane=r,w._buildText=o,w._buildAddressText=h,w._updatePlaneTexture=l,w._update=u,w._buildAddressDot=s,w._buildRedDot=i,w.onOver=x,w.onOut=T,e}();